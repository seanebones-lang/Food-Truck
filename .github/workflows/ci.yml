name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  lint-and-test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        workspace: [shared, admin-app, customer-app]
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24.12.0'
          cache: 'yarn'
      
      - name: Setup Yarn
        run: corepack enable && corepack prepare yarn@4.12.0 --activate
      
      - name: Install dependencies
        run: yarn install --frozen-lockfile
      
      - name: Lint ${{ matrix.workspace }}
        run: yarn workspace ${{ matrix.workspace }} lint
        continue-on-error: true
      
      - name: Type check ${{ matrix.workspace }}
        run: yarn workspace ${{ matrix.workspace }} type-check
        continue-on-error: true
        if: matrix.workspace != 'customer-app' # Customer app uses Expo's TypeScript config
  
  test:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24.12.0'
          cache: 'yarn'
      
      - name: Setup Yarn
        run: corepack enable && corepack prepare yarn@4.12.0 --activate
      
      - name: Install dependencies
        run: yarn install --frozen-lockfile
      
      - name: Run tests
        run: yarn workspace customer-app test --coverage
      
      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          files: ./packages/customer-app/coverage/coverage-final.json
          flags: customer-app
          fail_ci_if_error: false
  
  security-audit:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24.12.0'
          cache: 'yarn'
      
      - name: Setup Yarn
        run: corepack enable && corepack prepare yarn@4.12.0 --activate
      
      - name: Install dependencies
        run: yarn install --frozen-lockfile
      
      - name: Run security audit
        run: yarn audit --level moderate
        continue-on-error: true
  
  build:
    runs-on: ubuntu-latest
    needs: [lint-and-test]
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24.12.0'
          cache: 'yarn'
      
      - name: Setup Yarn
        run: corepack enable && corepack prepare yarn@4.12.0 --activate
      
      - name: Install dependencies
        run: yarn install --frozen-lockfile
      
      - name: Build admin app
        run: yarn admin:build
        env:
          VITE_API_URL: ${{ secrets.VITE_API_URL || 'http://localhost:3001' }}
      
      - name: Generate Prisma client
        run: yarn db:generate
      
      - name: Check Prisma migrations
        run: yarn db:migrate --create-only
        continue-on-error: true