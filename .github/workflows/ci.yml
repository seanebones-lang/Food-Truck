name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  NODE_VERSION: '18.x'
  EXPO_VERSION: 'latest'

jobs:
  lint-and-test:
    name: Lint & Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'yarn'

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Lint customer app
        run: cd packages/customer-app && yarn lint

      - name: Lint admin app
        run: cd packages/admin-app && yarn lint

      - name: Run unit tests
        run: cd packages/customer-app && yarn test --coverage --maxWorkers=2

      - name: Upload coverage
        uses: codecov/codecov-action@v3
        with:
          files: ./packages/customer-app/coverage/lcov.info
          flags: customer-app
          name: customer-app-coverage

  build-customer-app:
    name: Build Customer App
    runs-on: ubuntu-latest
    needs: lint-and-test
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'yarn'

      - name: Setup Expo
        uses: expo/expo-github-action@v8
        with:
          expo-version: ${{ env.EXPO_VERSION }}
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Build Android APK (Preview)
        if: github.ref == 'refs/heads/develop'
        run: cd packages/customer-app && eas build --platform android --profile preview --non-interactive
        env:
          EXPO_PUBLIC_ENV: staging
          EXPO_PUBLIC_API_URL: ${{ secrets.STAGING_API_URL }}
          EXPO_PUBLIC_SOCKET_URL: ${{ secrets.STAGING_SOCKET_URL }}
          EXPO_PUBLIC_SENTRY_DSN: ${{ secrets.SENTRY_DSN }}

      - name: Build iOS (Preview)
        if: github.ref == 'refs/heads/develop'
        run: cd packages/customer-app && eas build --platform ios --profile preview --non-interactive
        env:
          EXPO_PUBLIC_ENV: staging
          EXPO_PUBLIC_API_URL: ${{ secrets.STAGING_API_URL }}
          EXPO_PUBLIC_SOCKET_URL: ${{ secrets.STAGING_SOCKET_URL }}
          EXPO_PUBLIC_SENTRY_DSN: ${{ secrets.SENTRY_DSN }}

      - name: Build Android APK (Production)
        if: github.ref == 'refs/heads/main'
        run: cd packages/customer-app && eas build --platform android --profile production --non-interactive
        env:
          EXPO_PUBLIC_ENV: production
          EXPO_PUBLIC_API_URL: ${{ secrets.PRODUCTION_API_URL }}
          EXPO_PUBLIC_SOCKET_URL: ${{ secrets.PRODUCTION_SOCKET_URL }}
          EXPO_PUBLIC_SENTRY_DSN: ${{ secrets.SENTRY_DSN }}

      - name: Build iOS (Production)
        if: github.ref == 'refs/heads/main'
        run: cd packages/customer-app && eas build --platform ios --profile production --non-interactive
        env:
          EXPO_PUBLIC_ENV: production
          EXPO_PUBLIC_API_URL: ${{ secrets.PRODUCTION_API_URL }}
          EXPO_PUBLIC_SOCKET_URL: ${{ secrets.PRODUCTION_SOCKET_URL }}
          EXPO_PUBLIC_SENTRY_DSN: ${{ secrets.SENTRY_DSN }}

  build-admin-app:
    name: Build Admin App
    runs-on: ubuntu-latest
    needs: lint-and-test
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'yarn'

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Build admin app
        run: cd packages/admin-app && yarn build
        env:
          VITE_API_URL: ${{ secrets.VITE_API_URL }}
          VITE_SOCKET_URL: ${{ secrets.VITE_SOCKET_URL }}

      - name: Deploy to Vercel (Staging)
        if: github.ref == 'refs/heads/develop'
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: '--prod=false'

      - name: Deploy to Vercel (Production)
        if: github.ref == 'refs/heads/main'
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: '--prod'

  deploy-backend:
    name: Deploy Backend
    runs-on: ubuntu-latest
    needs: lint-and-test
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'yarn'

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Deploy to Vercel
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_BACKEND_PROJECT_ID }}
          vercel-args: ${{ github.ref == 'refs/heads/main' && '--prod' || '--prod=false' }}
          working-directory: ./
          root-directory: ./
