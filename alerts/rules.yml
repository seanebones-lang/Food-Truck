# Prometheus Alert Rules
# For use with Prometheus Alertmanager
# 
# Installation:
# 1. Configure Prometheus to load these rules
# 2. Set up Alertmanager for notification routing
# 3. Configure notification channels (Slack, email, PagerDuty, etc.)

groups:
  - name: api_alerts
    interval: 30s
    rules:
      # Slow Request Alert
      - alert: SlowAPIRequests
        expr: http_response_time_p95_seconds > 1
        for: 5m
        labels:
          severity: warning
          component: api
        annotations:
          summary: "High API response times detected"
          description: "P95 response time is {{ $value }}s (threshold: 1s) for 5 minutes"

      # High Error Rate Alert
      - alert: HighErrorRate
        expr: rate(http_requests_by_status_total{status="5xx"}[5m]) / rate(http_requests_total[5m]) > 0.05
        for: 2m
        labels:
          severity: critical
          component: api
        annotations:
          summary: "High error rate detected"
          description: "Error rate is {{ $value | humanizePercentage }} (threshold: 5%) for 2 minutes"

      # Very High Error Rate Alert
      - alert: VeryHighErrorRate
        expr: rate(http_requests_by_status_total{status="5xx"}[5m]) / rate(http_requests_total[5m]) > 0.10
        for: 1m
        labels:
          severity: critical
          component: api
        annotations:
          summary: "Very high error rate detected"
          description: "Error rate is {{ $value | humanizePercentage }} (threshold: 10%) for 1 minute"

  - name: database_alerts
    interval: 30s
    rules:
      # Slow Database Queries Alert
      - alert: SlowDatabaseQueries
        expr: rate(database_queries_slow_total[5m]) / rate(database_queries_total[5m]) > 0.10
        for: 5m
        labels:
          severity: warning
          component: database
        annotations:
          summary: "High percentage of slow database queries"
          description: "{{ $value | humanizePercentage }} of queries are slow (>100ms) for 5 minutes"

      # Database Connection Issues
      - alert: DatabaseConnectionIssues
        expr: up{job="food-truck-api"} == 0
        for: 1m
        labels:
          severity: critical
          component: database
        annotations:
          summary: "Database connection issues"
          description: "Unable to connect to database for 1 minute"

  - name: cache_alerts
    interval: 30s
    rules:
      # Low Cache Hit Rate Alert
      - alert: LowCacheHitRate
        expr: cache_hit_rate < 0.50
        for: 10m
        labels:
          severity: warning
          component: cache
        annotations:
          summary: "Low cache hit rate"
          description: "Cache hit rate is {{ $value | humanizePercentage }} (threshold: 50%) for 10 minutes"

      # Very Low Cache Hit Rate Alert
      - alert: VeryLowCacheHitRate
        expr: cache_hit_rate < 0.30
        for: 5m
        labels:
          severity: critical
          component: cache
        annotations:
          summary: "Very low cache hit rate"
          description: "Cache hit rate is {{ $value | humanizePercentage }} (threshold: 30%) for 5 minutes"

  - name: system_alerts
    interval: 30s
    rules:
      # Health Check Failure
      - alert: HealthCheckFailure
        expr: up{job="food-truck-api"} == 0
        for: 2m
        labels:
          severity: critical
          component: system
        annotations:
          summary: "Health check failed"
          description: "API health check has been failing for 2 minutes"

      # High Memory Usage
      - alert: HighMemoryUsage
        expr: process_memory_usage_bytes{type="heap"} / 1024 / 1024 / 1024 > 0.8
        for: 5m
        labels:
          severity: warning
          component: system
        annotations:
          summary: "High memory usage"
          description: "Memory usage is {{ $value }}GB (threshold: 80%) for 5 minutes"

      # Service Down
      - alert: ServiceDown
        expr: up{job="food-truck-api"} == 0
        for: 5m
        labels:
          severity: critical
          component: system
        annotations:
          summary: "Service is down"
          description: "Food Truck API service has been down for 5 minutes"
